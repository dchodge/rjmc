<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example 2: SEIR change-point attack rate • rjmc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Example 2: SEIR change-point attack rate">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rjmc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Ex1_mixture.html">Example 1: Mixture model</a>
    </li>
    <li>
      <a href="../articles/Ex2_seir_attack_rate.html">Example 2: SEIR change-point attack rate</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Example 2: SEIR change-point attack rate</h1>
                        <h4 data-toc-skip class="author">David
Hodgson</h4>
            
            <h4 data-toc-skip class="date">2025-09-30</h4>
      

      <div class="hidden name"><code>Ex2_seir_attack_rate.Rmd</code></div>

    </div>

    
    
<!-- Triggering GitHub Actions workflow -->
<p>This vignette demonstrates using RJMCMC to infer a piecewise-constant
attack/transmission rate (change-point analysis) in a simple SEIR model
from simulated incidence data.</p>
<ul>
<li>The time-varying transmission rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\beta(t)</annotation></semantics></math>
is modeled as a step function with an unknown number of segments and
unknown change-points.</li>
<li>RJMCMC explores the model dimension by proposing birth/death moves
on the number of segments, and random-walk updates to segment-specific
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
values.</li>
<li>We show recovery of both the number and locations of change-points
and the underlying incidence curve.</li>
</ul>
<p><strong>Note</strong>: All safety checks and validation functions
have been extracted to separate R files to make this vignette more
concise and maintainable. When running this vignette interactively,
these functions will be automatically loaded. For pkgdown builds, the
functions are already available through the package.</p>
<div class="section level2">
<h2 id="packages">1. Packages<a class="anchor" aria-label="anchor" href="#packages"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/tidybayes/" class="external-link">tidybayes</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/ggdist/" class="external-link">ggdist</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load safety check functions (only when running interactively)</span></span>
<span><span class="co"># These functions provide comprehensive input validation and safe defaults</span></span>
<span><span class="co"># See R/safety_check_Ex2.R for full documentation</span></span>
<span><span class="co"># Note: In pkgdown builds, these functions are available through the package</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"R/safety_check_Ex2.R"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Load corrected birth and death functions</span></span>
<span>  <span class="co"># These functions match the thesis exactly and include proper dimension checks</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"R/corrected_birth_death.R"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Load simple and robust birth/death functions</span></span>
<span>  <span class="co"># These are much simpler and more standard implementations</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"R/simple_birth_death.R"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Using more than one core might fail on windows</span></span>
<span><span class="va">aaa_mc_cores</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">.Platform</span><span class="op">$</span><span class="va">OS.type</span> <span class="op">==</span> <span class="st">"windows"</span><span class="op">)</span> <span class="fl">1</span> <span class="kw">else</span> <span class="fl">2</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulate-seir-with-piecewise-constant-transmission-rate">2. Simulate SEIR with piecewise-constant transmission rate<a class="anchor" aria-label="anchor" href="#simulate-seir-with-piecewise-constant-transmission-rate"></a>
</h2>
<p>We simulate a discrete-time SEIR model (day step) with a
piecewise-constant
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\beta(t)</annotation></semantics></math>
and normal observation noise on daily incidence.</p>
<ul>
<li>Population:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>100</mn><mo>,</mo><mn>000</mn></mrow><annotation encoding="application/x-tex">N = 100{,}000</annotation></semantics></math>
</li>
<li>Latent period:
1/<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
= 4 days</li>
<li>Infectious period:
1/<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>γ</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>
= 6 days</li>
<li>Change-points at days 40 and 80 with segment values: 0.30, 0.01,
0.40</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Helper to expand piecewise-constant beta from segment endpoints</span></span>
<span><span class="va">make_beta_t</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">beta_vec</span>, <span class="va">cp_vec</span>, <span class="va">T</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Use safety check functions</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_make_beta_t_inputs</span><span class="op">(</span><span class="va">beta_vec</span>, <span class="va">cp_vec</span>, <span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">create_safe_beta</span><span class="op">(</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Ensure change-points are within bounds and ordered</span></span>
<span>  <span class="va">ends</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cp_vec</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, <span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="va">ends</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ends</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">T</span></span>
<span>  </span>
<span>  <span class="va">starts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ends</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Initialize output vector</span></span>
<span>  <span class="va">beta_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="cn">T</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Fill in segment values</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">beta_vec</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">k</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">starts</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">k</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ends</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">start_idx</span> <span class="op">&lt;-</span> <span class="va">starts</span><span class="op">[</span><span class="va">k</span><span class="op">]</span></span>
<span>      <span class="va">end_idx</span> <span class="op">&lt;-</span> <span class="va">ends</span><span class="op">[</span><span class="va">k</span><span class="op">]</span></span>
<span>      </span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">start_idx</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">end_idx</span><span class="op">)</span> <span class="op">&amp;&amp;</span> </span>
<span>          <span class="va">start_idx</span> <span class="op">&gt;=</span> <span class="fl">1</span> <span class="op">&amp;&amp;</span> <span class="va">end_idx</span> <span class="op">&lt;=</span> <span class="cn">T</span> <span class="op">&amp;&amp;</span> <span class="va">start_idx</span> <span class="op">&lt;=</span> <span class="va">end_idx</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">idx</span> <span class="op">&lt;-</span> <span class="va">start_idx</span><span class="op">:</span><span class="va">end_idx</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">idx</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">beta_t</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">beta_vec</span><span class="op">[</span><span class="va">k</span><span class="op">]</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Final safety check</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">beta_t</span><span class="op">)</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">beta_t</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">create_safe_beta</span><span class="op">(</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">beta_t</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Deterministic SEIR forward solver for expected incidence</span></span>
<span><span class="va">seir_expected_incidence</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">T</span>, <span class="va">N</span>, <span class="va">beta_t</span>, <span class="va">gamma</span>, <span class="va">S0</span>, <span class="va">E0</span>, <span class="va">I0</span>, <span class="va">R0</span>, <span class="va">rho</span> <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Use safety check functions</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_seir_inputs</span><span class="op">(</span><span class="cn">T</span>, <span class="va">N</span>, <span class="va">beta_t</span>, <span class="va">gamma</span>, <span class="va">S0</span>, <span class="va">E0</span>, <span class="va">I0</span>, <span class="va">R0</span>, <span class="va">rho</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">create_safe_seir_result</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Initialize arrays</span></span>
<span>  <span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span>; <span class="va">E</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span>; <span class="va">I</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span>; <span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="va">inc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Set initial conditions</span></span>
<span>  <span class="va">S</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">S0</span><span class="op">)</span>; <span class="va">E</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">E0</span><span class="op">)</span>; <span class="va">I</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">I0</span><span class="op">)</span>; <span class="va">R</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">R0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Forward simulation</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="cn">T</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Safety check for current state</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">E</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">I</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">R</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">S</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">S0</span><span class="op">)</span>; <span class="va">E</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">E0</span><span class="op">)</span>; <span class="va">I</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">I0</span><span class="op">)</span>; <span class="va">R</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">R0</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Calculate transmission rate</span></span>
<span>    <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">beta_t</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">*</span> <span class="va">I</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">/</span> <span class="va">N</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span> <span class="op">||</span> <span class="va">lambda</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    </span>
<span>    <span class="co"># Calculate transitions</span></span>
<span>    <span class="va">new_inf</span> <span class="op">&lt;-</span> <span class="va">lambda</span> <span class="op">*</span> <span class="va">S</span><span class="op">[</span><span class="va">t</span><span class="op">]</span></span>
<span>    <span class="va">new_E_to_I</span> <span class="op">&lt;-</span> <span class="va">gamma</span> <span class="op">*</span> <span class="va">E</span><span class="op">[</span><span class="va">t</span><span class="op">]</span></span>
<span>    <span class="va">new_I_to_R</span> <span class="op">&lt;-</span> <span class="va">gamma</span> <span class="op">*</span> <span class="va">I</span><span class="op">[</span><span class="va">t</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># Safety checks for transitions</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">new_inf</span><span class="op">)</span> <span class="op">||</span> <span class="va">new_inf</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">new_inf</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">new_E_to_I</span><span class="op">)</span> <span class="op">||</span> <span class="va">new_E_to_I</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">new_E_to_I</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">new_I_to_R</span><span class="op">)</span> <span class="op">||</span> <span class="va">new_I_to_R</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">new_I_to_R</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    </span>
<span>    <span class="co"># Record incidence</span></span>
<span>    <span class="va">inc</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rho</span> <span class="op">*</span> <span class="va">new_inf</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">inc</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">||</span> <span class="va">inc</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">inc</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    </span>
<span>    <span class="co"># Update states for next time step</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">&lt;</span> <span class="cn">T</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">S</span><span class="op">[</span><span class="va">t</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">-</span> <span class="va">new_inf</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>      <span class="va">E</span><span class="op">[</span><span class="va">t</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">E</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">+</span> <span class="va">new_inf</span> <span class="op">-</span> <span class="va">new_E_to_I</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>      <span class="va">I</span><span class="op">[</span><span class="va">t</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">I</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">+</span> <span class="va">new_E_to_I</span> <span class="op">-</span> <span class="va">new_I_to_R</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>      <span class="va">R</span><span class="op">[</span><span class="va">t</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">R</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">+</span> <span class="va">new_I_to_R</span>, <span class="va">N</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Safety checks for next state</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="va">t</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="va">S</span><span class="op">[</span><span class="va">t</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">S0</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">E</span><span class="op">[</span><span class="va">t</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="va">E</span><span class="op">[</span><span class="va">t</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">E0</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">I</span><span class="op">[</span><span class="va">t</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="va">I</span><span class="op">[</span><span class="va">t</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">I0</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">R</span><span class="op">[</span><span class="va">t</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="va">R</span><span class="op">[</span><span class="va">t</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">R0</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Final safety check for output</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span><span class="op">)</span> <span class="op">||</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">inc</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">create_safe_seir_result</span><span class="op">(</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>S <span class="op">=</span> <span class="va">S</span>, E <span class="op">=</span> <span class="va">E</span>, I <span class="op">=</span> <span class="va">I</span>, R <span class="op">=</span> <span class="va">R</span>, incidence <span class="op">=</span> <span class="va">inc</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Truth</span></span>
<span><span class="va">T_days</span> <span class="op">&lt;-</span> <span class="fl">120</span></span>
<span><span class="va">N_pop</span>  <span class="op">&lt;-</span> <span class="fl">100000</span></span>
<span><span class="va">sigma</span>  <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span></span>
<span><span class="va">gamma</span>  <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">6</span></span>
<span><span class="va">rho_true</span> <span class="op">&lt;-</span> <span class="fl">1.0</span></span>
<span><span class="va">beta_true_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.01</span>, <span class="fl">0.4</span><span class="op">)</span>  <span class="co"># Transmission rates between 0 and 1</span></span>
<span><span class="va">cp_true</span>        <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">80</span>, <span class="va">T_days</span><span class="op">)</span>  <span class="co"># segment endpoints (last must be T)</span></span>
<span><span class="va">beta_true_t</span>    <span class="op">&lt;-</span> <span class="fu">make_beta_t</span><span class="op">(</span><span class="va">beta_true_vals</span>, <span class="va">cp_true</span>, <span class="va">T_days</span><span class="op">)</span></span>
<span></span>
<span><span class="va">init_I</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="va">sim_true</span> <span class="op">&lt;-</span> <span class="fu">seir_expected_incidence</span><span class="op">(</span></span>
<span>  T <span class="op">=</span> <span class="va">T_days</span>, N <span class="op">=</span> <span class="va">N_pop</span>, beta_t <span class="op">=</span> <span class="va">beta_true_t</span>,</span>
<span>  gamma <span class="op">=</span> <span class="va">gamma</span>, S0 <span class="op">=</span> <span class="va">N_pop</span> <span class="op">-</span> <span class="va">init_I</span>, E0 <span class="op">=</span> <span class="fl">0</span>, I0 <span class="op">=</span> <span class="va">init_I</span>, R0 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  rho <span class="op">=</span> <span class="va">rho_true</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Observations: Poisson noise on expected incidence</span></span>
<span><span class="va">sigma_obs</span> <span class="op">&lt;-</span> <span class="fl">4</span>  <span class="co"># observation noise standard deviation (not used for Poisson)</span></span>
<span><span class="va">obs_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="va">T_days</span>, lambda <span class="op">=</span> <span class="va">sim_true</span><span class="op">$</span><span class="va">incidence</span><span class="op">)</span></span>
<span><span class="va">obs_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">obs_y</span>, <span class="fl">0</span><span class="op">)</span>  <span class="co"># ensure non-negative observations</span></span>
<span></span>
<span><span class="co"># Quick visuals</span></span>
<span><span class="va">p_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>day <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">T_days</span>, y <span class="op">=</span> <span class="va">obs_y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">day</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span>, color <span class="op">=</span> <span class="st">"grey20"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Day"</span>, y <span class="op">=</span> <span class="st">"Incidence"</span>, title <span class="op">=</span> <span class="st">"Simulated daily incidence (observed)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>day <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">T_days</span>, beta <span class="op">=</span> <span class="va">beta_true_t</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">day</span>, <span class="va">beta</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Day"</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">beta</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">)</span>, title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"True transmission "</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">beta</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="va">p_obs</span> <span class="op">/</span> <span class="va">p_beta</span></span></code></pre></div>
<p><img src="Ex2_seir_attack_rate_files/figure-html/simulate-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="rjmcmc-model-specification">3. RJMCMC model specification<a class="anchor" aria-label="anchor" href="#rjmcmc-model-specification"></a>
</h2>
<p>We define the model interface required by <code>rjmc_func</code>. The
<code>jump</code> matrix encodes the change-point segmentation:</p>
<ul>
<li>Row 1: segment-specific transmission rates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mi>k</mi></msub><annotation encoding="application/x-tex">\beta_k</annotation></semantics></math>
in [0, 1]</li>
<li>Row 2: segment end days (in 1..T), increasing, with the last equal
to T</li>
</ul>
<p>The continuous parameter vector contains a single parameter
controlling normal observation noise:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo>=</mo><msup><mi>e</mi><mi>θ</mi></msup></mrow><annotation encoding="application/x-tex">\sigma = e^{\theta}</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>θ</mi><annotation encoding="application/x-tex">\theta</annotation></semantics></math>
is unconstrained.</p>
<div class="section level3">
<h3 id="theoretical-framework">3.1 Theoretical Framework<a class="anchor" aria-label="anchor" href="#theoretical-framework"></a>
</h3>
<p>This implementation follows the RJMCMC theory from Lyyjynen (2014)
§5.2 for piecewise-constant intensity functions:</p>
<ul>
<li>
<strong>Prior on number of change-points</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>∼</mo><mtext mathvariant="normal">Poisson</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>μ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>λ</mi><mi>k</mi></mrow></msup></mrow><annotation encoding="application/x-tex">k \sim \text{Poisson}(\mu) \cdot e^{-\lambda k}</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mi>K</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k = K-1</annotation></semantics></math>
(K = number of segments)
<ul>
<li>Modified to strongly prefer fewer segments with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">\mu = 0.5</annotation></semantics></math>
and penalty factor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mn>2.0</mn></mrow><annotation encoding="application/x-tex">\lambda = 2.0</annotation></semantics></math>
</li>
</ul>
</li>
<li>
<strong>Prior on segment heights</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mi>k</mi></msub><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><mo>,</mo><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\beta_k \sim \text{Gamma}(\alpha, \beta)</annotation></semantics></math>
</li>
<li>
<strong>Prior on observation noise</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>σ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>∼</mo><mtext mathvariant="normal">Normal</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>10</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(\sigma) \sim \text{Normal}(\log(10), 1)</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
is the standard deviation</li>
<li>
<strong>Spacing prior</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>∝</mo><msubsup><mo>∏</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>s</mi><mi>j</mi></msub><mo>−</mo><msub><mi>s</mi><mrow><mi>j</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p(s) \propto \prod_{j=1}^{k+1} (s_j - s_{j-1})</annotation></semantics></math>
for ordered change-points</li>
<li>
<strong>Birth proposal</strong>: Split a segment at random point,
preserve weighted geometric mean of heights</li>
<li>
<strong>Death proposal</strong>: Merge adjacent segments, weighted
average of heights</li>
<li>
<strong>Acceptance ratios</strong>: Include proposal PDFs, Jacobian,
and prior ratios as per Green (1995)</li>
<li>
<strong>Likelihood</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>t</mi></msub><mo>∼</mo><mtext mathvariant="normal">Normal</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mi>t</mi></msub><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">y_t \sim \text{Normal}(\mu_t, \sigma^2)</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>μ</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\mu_t</annotation></semantics></math>
is the expected incidence from the SEIR model</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Build expected incidence given a jump matrix</span></span>
<span><span class="va">expected_incidence_from_jump</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Use safety check functions</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_rjmc_params</span><span class="op">(</span><span class="va">params</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"expected_incidence_from_jump: Expected 1 dummy parameter for Poisson model"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_datalist</span><span class="op">(</span><span class="va">datalist</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="fu">validate_jump_matrix</span><span class="op">(</span><span class="va">jump</span>, <span class="va">datalist</span><span class="op">$</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">datalist</span><span class="op">$</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Extract parameters</span></span>
<span>  <span class="cn">T</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="cn">T</span></span>
<span>  <span class="va">S0</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="va">S0</span></span>
<span>  <span class="va">E0</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="va">E0</span></span>
<span>  <span class="va">I0</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="va">I0</span></span>
<span>  <span class="va">R0</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="va">R0</span></span>
<span>  <span class="va">gamma</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="va">gamma</span></span>
<span>  <span class="va">rho</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="va">rho</span></span>
<span>  </span>
<span>  <span class="co"># Extract beta and change-points from jump</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">jump</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">cp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">jump</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Create piecewise-constant beta function</span></span>
<span>  <span class="va">beta_t</span> <span class="op">&lt;-</span> <span class="fu">make_beta_t</span><span class="op">(</span><span class="va">beta</span>, <span class="va">cp</span>, <span class="cn">T</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Solve SEIR model</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">seir_expected_incidence</span><span class="op">(</span><span class="cn">T</span>, <span class="va">datalist</span><span class="op">$</span><span class="va">N</span>, <span class="va">beta_t</span>, <span class="va">gamma</span>, <span class="va">S0</span>, <span class="va">E0</span>, <span class="va">I0</span>, <span class="va">R0</span>, <span class="va">rho</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Safety check for result</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">incidence</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Return only the incidence vector, not the entire result object</span></span>
<span>  <span class="va">result</span><span class="op">$</span><span class="va">incidence</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Helper function to compute Jacobian for birth transformation</span></span>
<span><span class="co"># Based on thesis §5.2: J ≈ h_parent / u2^2 for the (h_j, u1, u2) -&gt; (h_L, h_R, s*) mapping</span></span>
<span><span class="va">compute_birth_jacobian</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">beta_parent</span>, <span class="va">u2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Use safety check functions</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_numeric_param</span><span class="op">(</span><span class="va">beta_parent</span>, <span class="st">"beta_parent"</span>, min_val <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">||</span> </span>
<span>      <span class="op">!</span><span class="fu">validate_numeric_param</span><span class="op">(</span><span class="va">u2</span>, <span class="st">"u2"</span>, min_val <span class="op">=</span> <span class="fl">0.001</span>, max_val <span class="op">=</span> <span class="fl">0.999</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fl">1.0</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Simplified Jacobian: J ≈ h_parent / u2^2</span></span>
<span>  <span class="va">jacobian</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">beta_parent</span> <span class="op">/</span> <span class="op">(</span><span class="va">u2</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Bound the Jacobian to reasonable values</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">jacobian</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Helper function to compute Jacobian for death transformation</span></span>
<span><span class="co"># Based on thesis §5.2: J ≈ 1 for the death move (inverse of birth)</span></span>
<span><span class="va">compute_death_jacobian</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">beta_merged</span>, <span class="va">beta_old</span>, <span class="va">w_minus</span>, <span class="va">w_plus</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Use safety check functions</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_numeric_param</span><span class="op">(</span><span class="va">beta_merged</span>, <span class="st">"beta_merged"</span>, min_val <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">||</span></span>
<span>      <span class="op">!</span><span class="fu">validate_numeric_param</span><span class="op">(</span><span class="va">beta_old</span>, <span class="st">"beta_old"</span>, min_val <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">||</span></span>
<span>      <span class="op">!</span><span class="fu">validate_numeric_param</span><span class="op">(</span><span class="va">w_minus</span>, <span class="st">"w_minus"</span>, min_val <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span> <span class="op">||</span></span>
<span>      <span class="op">!</span><span class="fu">validate_numeric_param</span><span class="op">(</span><span class="va">w_plus</span>, <span class="st">"w_plus"</span>, min_val <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fl">1.0</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># For death moves, the Jacobian is approximately 1</span></span>
<span>  <span class="fl">1.0</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Helper function for proposal probabilities (to avoid circular references)</span></span>
<span><span class="va">sampleProposal_internal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Use safety check functions</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_rjmc_params</span><span class="op">(</span><span class="va">params</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="fu">validate_jump_matrix</span><span class="op">(</span><span class="va">jump</span>, <span class="va">datalist</span><span class="op">$</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.33</span>, <span class="fl">0.33</span>, <span class="fl">1.0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Based on thesis §5.2: birth/death probabilities derived from Poisson prior</span></span>
<span>  <span class="va">K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">jump</span><span class="op">)</span></span>
<span>  <span class="va">k</span> <span class="op">&lt;-</span> <span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>  <span class="co"># number of change-points</span></span>
<span>  </span>
<span>  <span class="co"># Prior parameters</span></span>
<span>  <span class="va">mu_prior</span> <span class="op">&lt;-</span> <span class="fl">2.5</span>  <span class="co"># Poisson prior mean for number of change-points</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">K</span> <span class="op">&lt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span><span class="op">)</span><span class="op">)</span>  <span class="co"># only birth and within-model moves</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">0.5</span>, <span class="fl">1.0</span><span class="op">)</span><span class="op">)</span>  <span class="co"># only death and within-model moves</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># Compute birth/death probabilities based on Poisson prior ratios</span></span>
<span>    <span class="va">bk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">0.6</span> <span class="op">*</span> <span class="va">mu_prior</span> <span class="op">/</span> <span class="op">(</span><span class="va">k</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0.6</span><span class="op">)</span></span>
<span>    <span class="va">dk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">0.6</span> <span class="op">*</span> <span class="va">k</span> <span class="op">/</span> <span class="va">mu_prior</span>, <span class="fl">0.6</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Ensure probabilities are finite and non-negative</span></span>
<span>    <span class="va">bk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">bk</span>, <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">dk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dk</span>, <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Ensure probabilities sum to at most 0.9</span></span>
<span>    <span class="va">total</span> <span class="op">&lt;-</span> <span class="va">bk</span> <span class="op">+</span> <span class="va">dk</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">total</span> <span class="op">&gt;</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">scale_factor</span> <span class="op">&lt;-</span> <span class="fl">0.9</span> <span class="op">/</span> <span class="va">total</span></span>
<span>      <span class="va">bk</span> <span class="op">&lt;-</span> <span class="va">bk</span> <span class="op">*</span> <span class="va">scale_factor</span></span>
<span>      <span class="va">dk</span> <span class="op">&lt;-</span> <span class="va">dk</span> <span class="op">*</span> <span class="va">scale_factor</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bk</span>, <span class="va">dk</span>, <span class="fl">1.0</span><span class="op">)</span>  <span class="co"># birth, death, within-model</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># RJMCMC model list</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  lowerParSupport_fitted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span><span class="op">)</span>,  <span class="co"># Dummy parameter bounds</span></span>
<span>  upperParSupport_fitted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  namesOfParameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dummy"</span><span class="op">)</span>,  <span class="co"># Dummy parameter name</span></span>
<span></span>
<span>  sampleInitPrior <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># For Poisson model, we need a dummy parameter for internal RJMCMC machinery</span></span>
<span>    <span class="co"># Initialize dummy parameter around 0</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Use safety check functions</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_numeric_param</span><span class="op">(</span><span class="va">result</span>, <span class="st">"result"</span>, allow_null <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>  <span class="co"># Return safe default if generation failed</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">result</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  sampleInitJump <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Use safety check functions</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_rjmc_params</span><span class="op">(</span><span class="va">params</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="fu">validate_datalist</span><span class="op">(</span><span class="va">datalist</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">create_safe_jump</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="cn">T</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="cn">T</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_numeric_param</span><span class="op">(</span><span class="cn">T</span>, <span class="st">"T"</span>, min_val <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">create_safe_jump</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># SIMPLIFIED: Start with exactly 2 segments for stability</span></span>
<span>    <span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Initialization: K ="</span>, <span class="va">K</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Create 2 segments with reasonable beta values</span></span>
<span>    <span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span><span class="op">)</span>  <span class="co"># Reasonable beta values</span></span>
<span>    </span>
<span>    <span class="co"># Place change-point at 1/3 of time range (more balanced than middle)</span></span>
<span>    <span class="co"># This avoids clustering at the start and gives more reasonable segment sizes</span></span>
<span>    <span class="va">cps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="cn">T</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>, <span class="cn">T</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Safety check for generated values</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">betas</span><span class="op">)</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">cps</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">create_safe_jump</span><span class="op">(</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Ensure change-points are valid and ordered</span></span>
<span>    <span class="va">cps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">cps</span><span class="op">)</span></span>
<span>    <span class="va">cps</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cps</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">T</span>  <span class="co"># Ensure last change-point is exactly T</span></span>
<span>    </span>
<span>    <span class="co"># Final safety check</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">cps</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">cps</span> <span class="op">&gt;</span> <span class="cn">T</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">betas</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">create_safe_jump</span><span class="op">(</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">betas</span>, <span class="va">cps</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Final matrix check</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">!=</span> <span class="va">K</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">create_safe_jump</span><span class="op">(</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">result</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  evaluateLogPrior <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Use safety check functions</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_rjmc_params</span><span class="op">(</span><span class="va">params</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"evaluateLogPrior: Expected 1 dummy parameter for Poisson model"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Start with zero log prior (flat prior on dummy parameter)</span></span>
<span>    <span class="va">lp</span> <span class="op">&lt;-</span> <span class="fl">0.0</span></span>
<span>    </span>
<span>    <span class="co"># Safety check for jump</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_jump_matrix</span><span class="op">(</span><span class="va">jump</span>, <span class="va">datalist</span><span class="op">$</span><span class="cn">T</span>, min_segments <span class="op">=</span> <span class="fl">1</span>, max_segments <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Number of change-points: k ~ Poisson(μ) where k = K-1</span></span>
<span>    <span class="va">K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">jump</span><span class="op">)</span></span>
<span>    <span class="va">k</span> <span class="op">&lt;-</span> <span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>  <span class="co"># number of change-points (excluding boundaries)</span></span>
<span>    </span>
<span>    <span class="co"># Prior that allows reasonable number of change points</span></span>
<span>    <span class="va">mu_prior</span> <span class="op">&lt;-</span> <span class="fl">3</span>  <span class="co"># prior mean for number of change-points</span></span>
<span>    </span>
<span>    <span class="co"># Simple Poisson prior without additional penalty</span></span>
<span>    <span class="va">lp</span> <span class="op">&lt;-</span> <span class="va">lp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">k</span>, lambda <span class="op">=</span> <span class="va">mu_prior</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Safety check for Poisson prior</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">lp</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Segment heights (betas): ~ Gamma(α,β) instead of uniform</span></span>
<span>    <span class="va">beta_vec</span> <span class="op">&lt;-</span> <span class="va">jump</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span>    <span class="va">alpha_prior</span> <span class="op">&lt;-</span> <span class="fl">2.0</span>  <span class="co"># shape parameter</span></span>
<span>    <span class="va">beta_prior</span> <span class="op">&lt;-</span> <span class="fl">5.0</span>   <span class="co"># rate parameter (mean = α/β = 2.0/5.0 = 0.4)</span></span>
<span>    <span class="va">lp</span> <span class="op">&lt;-</span> <span class="va">lp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">beta_vec</span>, shape <span class="op">=</span> <span class="va">alpha_prior</span>, rate <span class="op">=</span> <span class="va">beta_prior</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Safety check for Gamma prior</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">lp</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Change-points: ordered spacing prior</span></span>
<span>    <span class="cn">T</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="cn">T</span></span>
<span>    <span class="va">cp_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">jump</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Spacing prior: log(prod(widths)) from thesis (5.33)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cp_vec</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">starts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cp_vec</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">widths</span> <span class="op">&lt;-</span> <span class="va">cp_vec</span> <span class="op">-</span> <span class="va">starts</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">widths</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span>  <span class="co"># Safety check for widths</span></span>
<span>      <span class="va">lp</span> <span class="op">&lt;-</span> <span class="va">lp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">widths</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Final safety check</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">lp</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Debug output for extreme values</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">lp</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1e6</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"WARNING: Very low prior:"</span>, <span class="va">lp</span>, <span class="st">"K ="</span>, <span class="va">K</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">lp</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  evaluateLogLikelihood <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">y</span>   <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="va">y</span></span>
<span>    <span class="cn">T</span>   <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="cn">T</span></span>
<span>    </span>
<span>    <span class="co"># Use safety check functions</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_rjmc_params</span><span class="op">(</span><span class="va">params</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"evaluateLogLikelihood: Expected 1 dummy parameter for Poisson model"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">mu_t</span> <span class="op">&lt;-</span> <span class="fu">expected_incidence_from_jump</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">datalist</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Safety checks for expected incidence</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">mu_t</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">mu_t</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">mu_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">mu_t</span>, <span class="fl">1e-6</span><span class="op">)</span>  <span class="co"># ensure positive expected values</span></span>
<span></span>
<span>    <span class="co"># Poisson likelihood for counts: y_t ~ Poisson(mu_t)</span></span>
<span>    <span class="va">log_lik</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">y</span>, lambda <span class="op">=</span> <span class="va">mu_t</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">log_lik</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Simple dimension penalty (much smaller)</span></span>
<span>    <span class="va">K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">jump</span><span class="op">)</span></span>
<span>    <span class="va">penalty_term</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.1</span>  <span class="co"># Small penalty for complexity</span></span>
<span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">log_lik</span><span class="op">)</span> <span class="op">-</span> <span class="va">penalty_term</span></span>
<span>    </span>
<span>    <span class="co"># Debug output for extreme values</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">result</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1e6</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"WARNING: Very low likelihood:"</span>, <span class="va">result</span>, <span class="st">"K ="</span>, <span class="va">K</span>, <span class="st">"sum(log_lik) ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">log_lik</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">result</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  sampleBirthProposal <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">i_idx</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Use simple birth function that's more robust</span></span>
<span>    <span class="fu">simpleBirthProposal</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">i_idx</span>, <span class="va">datalist</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span>  sampleDeathProposal <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">i_idx</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Use simple death function that's more robust</span></span>
<span>    <span class="fu">simpleDeathProposal</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">i_idx</span>, <span class="va">datalist</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  evaluateBirthProposal <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">i_idx</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Use safety check functions</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_rjmc_params</span><span class="op">(</span><span class="va">params</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="fu">validate_jump_matrix</span><span class="op">(</span><span class="va">jump</span>, <span class="va">datalist</span><span class="op">$</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Based on thesis §5.2: birth acceptance ratio with proper proposal PDFs</span></span>
<span>    <span class="cn">T</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="cn">T</span></span>
<span>    <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">jump</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">cp</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">jump</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">K</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Get current birth/death probabilities</span></span>
<span>    <span class="va">move_probs</span> <span class="op">&lt;-</span> <span class="fu">sampleProposal_internal</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">datalist</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Safety check for move_probs</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">move_probs</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">2</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">move_probs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">bk</span> <span class="op">&lt;-</span> <span class="va">move_probs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>  <span class="co"># birth probability</span></span>
<span>    <span class="va">dk1</span> <span class="op">&lt;-</span> <span class="va">move_probs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="co"># death probability in new state (k+1)</span></span>
<span>    </span>
<span>    <span class="co"># Safety check for probabilities</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">bk</span> <span class="op">&lt;=</span> <span class="fl">0</span> <span class="op">||</span> <span class="va">dk1</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Proposal ratio: log(d_{k+1} * L / (b_k * (k+1))) from thesis (5.50)</span></span>
<span>    <span class="va">log_prop_ratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">dk1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">bk</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">K</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Safety check for final result</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">log_prop_ratio</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">log_prop_ratio</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  evaluateDeathProposal <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">i_idx</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Use safety check functions</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">validate_rjmc_params</span><span class="op">(</span><span class="va">params</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="fu">validate_jump_matrix</span><span class="op">(</span><span class="va">jump</span>, <span class="va">datalist</span><span class="op">$</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Based on thesis §5.2: death acceptance ratio with proper proposal PDFs</span></span>
<span>    <span class="cn">T</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="cn">T</span></span>
<span>    <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">jump</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">cp</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">jump</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">K</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">K</span> <span class="op">&lt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># For death, the proposal ratio is the inverse of birth</span></span>
<span>    <span class="co"># From thesis (5.55): log(b_{k-1} * k / (d_k * L))</span></span>
<span>    </span>
<span>    <span class="co"># Get current birth/death probabilities</span></span>
<span>    <span class="va">move_probs</span> <span class="op">&lt;-</span> <span class="fu">sampleProposal_internal</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">datalist</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Safety check for move_probs</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">move_probs</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">2</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">move_probs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">dk</span> <span class="op">&lt;-</span> <span class="va">move_probs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>      <span class="co"># death probability in current state</span></span>
<span>    <span class="va">bk_minus1</span> <span class="op">&lt;-</span> <span class="va">move_probs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="co"># birth probability in new state (k-1)</span></span>
<span>    </span>
<span>    <span class="co"># Proposal ratio: log(b_{k-1} * k / (d_k * L))</span></span>
<span>    <span class="va">log_prop_ratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">bk_minus1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">dk</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Safety check for final result</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">log_prop_ratio</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">log_prop_ratio</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  sampleJump <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">i_idx</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Use simple height update function that's more robust</span></span>
<span>    <span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">alpha</span> <span class="op">&lt;</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">jump</span> <span class="op">&lt;-</span> <span class="fu">simpleHeightUpdate</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">i_idx</span>, <span class="va">datalist</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">alpha</span> <span class="op">&lt;</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">jump</span> <span class="op">&lt;-</span> <span class="fu">simpleChangePointUpdate</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">i_idx</span>, <span class="va">datalist</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">jump</span></span>
<span>  <span class="op">}</span>,</span>
<span>  </span>
<span></span>
<span>  sampleProposal <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">jump</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Simple, balanced proposal probabilities</span></span>
<span>    <span class="va">K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">jump</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">K</span> <span class="op">&lt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Can't have fewer than 1 segment - only birth and within-model</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.0</span>, <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span>  <span class="co"># birth, death, within-model</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Can't have more than 20 segments - only death and within-model</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span>  <span class="co"># birth, death, within-model</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># Balanced probabilities for intermediate K values</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span>  <span class="co"># birth, death, within-model</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="settings-data-and-run">4. Settings, data, and run<a class="anchor" aria-label="anchor" href="#settings-data-and-run"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  numberCores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  numberChainRuns <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">40000</span>,  <span class="co"># Increased from 10000 to allow more exploration</span></span>
<span>  burninPosterior <span class="op">=</span> <span class="fl">20000</span>,  <span class="co"># Increased from 5000 to allow proper burn-in</span></span>
<span>  thin <span class="op">=</span> <span class="fl">10</span>,  <span class="co"># Increased from 1 to reduce autocorrelation</span></span>
<span>  runParallel <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">obs_y</span>,</span>
<span>  N_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">obs_y</span><span class="op">)</span>,</span>
<span>  T <span class="op">=</span> <span class="va">T_days</span>,</span>
<span>  N <span class="op">=</span> <span class="va">N_pop</span>,</span>
<span>  gamma <span class="op">=</span> <span class="va">gamma</span>,</span>
<span>  S0 <span class="op">=</span> <span class="va">N_pop</span> <span class="op">-</span> <span class="va">init_I</span>,</span>
<span>  E0 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  I0 <span class="op">=</span> <span class="va">init_I</span>,</span>
<span>  R0 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  rho <span class="op">=</span> <span class="va">rho_true</span> <span class="co"># 1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rjmc_func.html">rjmc_func</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">data_l</span>, <span class="va">settings</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run diagnostics to check for mixing issues</span></span>
<span><span class="co">#saveRDS(outputs, here::here("outputs", "fits", "epi", "fit_seir_cp.RDS"))</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="posterior-analysis-and-recovery">5. Posterior analysis and recovery<a class="anchor" aria-label="anchor" href="#posterior-analysis-and-recovery"></a>
</h2>
<div class="section level3">
<h3 id="posterior-over-number-of-segments-change-points-1">5.1 Posterior over number of segments (change-points + 1)<a class="anchor" aria-label="anchor" href="#posterior-over-number-of-segments-change-points-1"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">K_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">outputs</span><span class="op">$</span><span class="va">jump</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="co"># number of posterior samples per chain</span></span>
<span><span class="va">K_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">outputs</span><span class="op">$</span><span class="va">jump</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>K <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_int</a></span><span class="op">(</span><span class="va">outputs</span><span class="op">$</span><span class="va">jump</span><span class="op">[[</span><span class="va">c</span><span class="op">]</span><span class="op">]</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">K_mode</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">K_tab</span><span class="op">$</span><span class="va">K</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">K_tab</span><span class="op">$</span><span class="va">prop</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">K_tab</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">prop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Number of segments (K)"</span>, y <span class="op">=</span> <span class="st">"Posterior proportion"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Posterior over number of segments"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Ex2_seir_attack_rate_files/figure-html/posterior_K-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="recover-transmission-rate-and-incidence-conditional-on-modal-k">5.2 Recover transmission rate and incidence (conditional on modal
K)<a class="anchor" aria-label="anchor" href="#recover-transmission-rate-and-incidence-conditional-on-modal-k"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract samples with K == K_mode across all chains</span></span>
<span><span class="va">samples_K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">outputs</span><span class="op">$</span><span class="va">jump</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">keep_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_int</a></span><span class="op">(</span><span class="va">outputs</span><span class="op">$</span><span class="va">jump</span><span class="op">[[</span><span class="va">c</span><span class="op">]</span><span class="op">]</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="va">K_mode</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">keep_idx</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="va">keep_idx</span>, <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">jump_mat</span> <span class="op">&lt;-</span> <span class="va">outputs</span><span class="op">$</span><span class="va">jump</span><span class="op">[[</span><span class="va">c</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">beta_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">jump_mat</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">cp_vec</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">jump_mat</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">beta_t</span>   <span class="op">&lt;-</span> <span class="fu">make_beta_t</span><span class="op">(</span><span class="va">beta_vec</span>, <span class="va">cp_vec</span>, <span class="va">T_days</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>chain <span class="op">=</span> <span class="va">c</span>, sample <span class="op">=</span> <span class="va">s</span>, day <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">T_days</span>, beta_t <span class="op">=</span> <span class="va">beta_t</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summaries for beta(t)</span></span>
<span><span class="va">beta_sum</span> <span class="op">&lt;-</span> <span class="va">samples_K</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mjskay.github.io/ggdist/reference/point_interval.html" class="external-link">mean_qi</a></span><span class="op">(</span><span class="va">beta_t</span>, .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta_sum_c</span> <span class="op">&lt;-</span> <span class="va">samples_K</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">day</span>, <span class="va">chain</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mjskay.github.io/ggdist/reference/point_interval.html" class="external-link">mean_qi</a></span><span class="op">(</span><span class="va">beta_t</span>, .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot with chain-specific colors</span></span>
<span><span class="va">p_beta_rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">beta_sum_c</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">day</span>, <span class="va">beta_t</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>day <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">T_days</span>, beta_t <span class="op">=</span> <span class="va">beta_true_t</span><span class="op">)</span>,</span>
<span>            color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Day"</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">beta</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Posterior "</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">beta</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">*</span><span class="st">" (modal K) with truth (red)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Incidence summaries from posterior beta paths</span></span>
<span><span class="va">inc_sum</span> <span class="op">&lt;-</span> <span class="va">samples_K</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">chain</span>, <span class="va">sample</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">seir_expected_incidence</span><span class="op">(</span></span>
<span>      T <span class="op">=</span> <span class="va">T_days</span>, N <span class="op">=</span> <span class="va">N_pop</span>, beta_t <span class="op">=</span> <span class="va">beta_t</span>,</span>
<span>      gamma <span class="op">=</span> <span class="va">gamma</span>, S0 <span class="op">=</span> <span class="va">N_pop</span> <span class="op">-</span> <span class="fl">1000</span>, E0 <span class="op">=</span> <span class="fl">0</span>, I0 <span class="op">=</span> <span class="fl">1000</span>, R0 <span class="op">=</span> <span class="fl">0</span>, rho <span class="op">=</span> <span class="va">rho_true</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">incidence</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">T_days</span><span class="op">)</span>,</span>
<span>    mu <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">mu</span>, <span class="va">day</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"day_"</span>, <span class="va">.y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest_longer.html" class="external-link">unnest_longer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mu</span>, <span class="va">day</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mjskay.github.io/ggdist/reference/point_interval.html" class="external-link">mean_qi</a></span><span class="op">(</span><span class="va">mu</span>, .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_inc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>day <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">T_days</span>, y <span class="op">=</span> <span class="va">obs_y</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">day</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>           fill <span class="op">=</span> <span class="st">"grey85"</span>, color <span class="op">=</span> <span class="st">"grey40"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">inc_sum</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">day</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span>,</span>
<span>              fill <span class="op">=</span> <span class="st">"tomato"</span>, alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">inc_sum</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">day</span>, y <span class="op">=</span> <span class="va">mu</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"tomato4"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Day"</span>, y <span class="op">=</span> <span class="st">"Incidence"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Posterior incidence (modal K) with observed data"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_beta_rec</span> <span class="op">/</span> <span class="va">p_inc</span></span></code></pre></div>
<p><img src="Ex2_seir_attack_rate_files/figure-html/posterior_beta_inc-1.png" width="672"></p>
<p>This analysis shows that RJMCMC can recover both the number and
locations of change-points in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\beta(t)</annotation></semantics></math>,
and yields posterior predictive incidence consistent with the simulated
data.</p>
</div>
<div class="section level3">
<h3 id="convergence-diagnostics-between-chains">5.3 Convergence Diagnostics Between Chains<a class="anchor" aria-label="anchor" href="#convergence-diagnostics-between-chains"></a>
</h3>
<p>Let’s check for convergence between chains by comparing the posterior
distributions of beta values and change-points.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract all samples across chains for convergence analysis</span></span>
<span><span class="va">all_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">outputs</span><span class="op">$</span><span class="va">jump</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">outputs</span><span class="op">$</span><span class="va">jump</span><span class="op">[[</span><span class="va">c</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">jump_mat</span> <span class="op">&lt;-</span> <span class="va">outputs</span><span class="op">$</span><span class="va">jump</span><span class="op">[[</span><span class="va">c</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">jump_mat</span><span class="op">)</span></span>
<span>    <span class="va">beta_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">jump_mat</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">cp_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">jump_mat</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>      chain <span class="op">=</span> <span class="va">c</span>,</span>
<span>      sample <span class="op">=</span> <span class="va">s</span>,</span>
<span>      K <span class="op">=</span> <span class="va">K</span>,</span>
<span>      beta_1 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">beta_vec</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      beta_2 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">)</span> <span class="va">beta_vec</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      beta_3 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="va">beta_vec</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      beta_4 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">4</span><span class="op">)</span> <span class="va">beta_vec</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      beta_5 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">5</span><span class="op">)</span> <span class="va">beta_vec</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      beta_6 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">6</span><span class="op">)</span> <span class="va">beta_vec</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      beta_7 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">7</span><span class="op">)</span> <span class="va">beta_vec</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      beta_8 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">8</span><span class="op">)</span> <span class="va">beta_vec</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      beta_9 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">9</span><span class="op">)</span> <span class="va">beta_vec</span><span class="op">[</span><span class="fl">9</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      beta_10 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">10</span><span class="op">)</span> <span class="va">beta_vec</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      cp_1 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">)</span> <span class="va">cp_vec</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      cp_2 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="va">cp_vec</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      cp_3 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">4</span><span class="op">)</span> <span class="va">cp_vec</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      cp_4 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">5</span><span class="op">)</span> <span class="va">cp_vec</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      cp_5 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">6</span><span class="op">)</span> <span class="va">cp_vec</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      cp_6 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">7</span><span class="op">)</span> <span class="va">cp_vec</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      cp_7 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">8</span><span class="op">)</span> <span class="va">cp_vec</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>,</span>
<span>      cp_8 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">K</span> <span class="op">&gt;=</span> <span class="fl">9</span><span class="op">)</span> <span class="va">cp_vec</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA_real_</span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Compare number of segments (K) between chains</span></span>
<span><span class="va">K_convergence</span> <span class="op">&lt;-</span> <span class="va">all_samples</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    mean_K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">K</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    sd_K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">K</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    median_K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">K</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    q25_K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">K</span>, <span class="fl">0.25</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    q75_K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">K</span>, <span class="fl">0.75</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Convergence check for number of segments (K):"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">K_convergence</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Compare beta values between chains (conditional on K)</span></span>
<span><span class="co"># Focus on the most common K value</span></span>
<span><span class="va">K_mode</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">all_samples</span><span class="op">$</span><span class="va">K</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nMost common K value:"</span>, <span class="va">K_mode</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract samples with K == K_mode for beta comparison</span></span>
<span><span class="va">beta_samples</span> <span class="op">&lt;-</span> <span class="va">all_samples</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">K</span> <span class="op">==</span> <span class="va">K_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">chain</span>, <span class="va">sample</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"beta_"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"beta_"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"segment"</span>, values_to <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>segment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"beta_"</span>, <span class="st">""</span>, <span class="va">segment</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Beta convergence by segment</span></span>
<span><span class="va">beta_convergence</span> <span class="op">&lt;-</span> <span class="va">beta_samples</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">segment</span>, <span class="va">chain</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    mean_beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">beta</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    sd_beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">beta</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    median_beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">beta</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    q25_beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">beta</span>, <span class="fl">0.25</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    q75_beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">beta</span>, <span class="fl">0.75</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"\nBeta convergence by segment and chain:"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">beta_convergence</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Compare change-points between chains (conditional on K)</span></span>
<span><span class="va">cp_samples</span> <span class="op">&lt;-</span> <span class="va">all_samples</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">K</span> <span class="op">==</span> <span class="va">K_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">chain</span>, <span class="va">sample</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"cp_"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"cp_"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"cp_idx"</span>, values_to <span class="op">=</span> <span class="st">"cp"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">cp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cp_idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"cp_"</span>, <span class="st">""</span>, <span class="va">cp_idx</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Change-point convergence by index</span></span>
<span><span class="va">cp_convergence</span> <span class="op">&lt;-</span> <span class="va">cp_samples</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cp_idx</span>, <span class="va">chain</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    mean_cp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    sd_cp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">cp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    median_cp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">cp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    q25_cp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">cp</span>, <span class="fl">0.25</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    q75_cp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">cp</span>, <span class="fl">0.75</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"\nChange-point convergence by index and chain:"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cp_convergence</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Visual convergence diagnostics</span></span>
<span><span class="co"># Beta values by chain and segment</span></span>
<span><span class="va">p_beta_conv</span> <span class="op">&lt;-</span> <span class="va">beta_samples</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">beta</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">segment</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, labeller <span class="op">=</span> <span class="va">label_both</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Chain"</span>, y <span class="op">=</span> <span class="st">"Beta value"</span>, title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Beta convergence across chains (K ="</span>, <span class="va">K_mode</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Change-points by chain and index</span></span>
<span><span class="va">p_cp_conv</span> <span class="op">&lt;-</span> <span class="va">cp_samples</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">cp</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">cp_idx</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, labeller <span class="op">=</span> <span class="va">label_both</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Chain"</span>, y <span class="op">=</span> <span class="st">"Change-point day"</span>, title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Change-point convergence across chains (K ="</span>, <span class="va">K_mode</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 5. Gelman-Rubin diagnostic (approximate)</span></span>
<span><span class="co"># Compute within-chain and between-chain variances for key parameters</span></span>
<span><span class="va">gelman_rubin</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">samples</span>, <span class="va">param_name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Check if the parameter column exists</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">param_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NA_real_</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Extract parameter values</span></span>
<span>  <span class="va">param_data</span> <span class="op">&lt;-</span> <span class="va">samples</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">chain</span>, <span class="va">sample</span>, <span class="op">!</span><span class="op">!</span><span class="va">param_name</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html" class="external-link">sym</a></span><span class="op">(</span><span class="va">param_name</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">param_data</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NA_real_</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Within-chain variance</span></span>
<span>  <span class="va">W</span> <span class="op">&lt;-</span> <span class="va">param_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>var_within <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html" class="external-link">sym</a></span><span class="op">(</span><span class="va">param_name</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">var_within</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Between-chain variance</span></span>
<span>  <span class="va">chain_means</span> <span class="op">&lt;-</span> <span class="va">param_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html" class="external-link">sym</a></span><span class="op">(</span><span class="va">param_name</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">mean_val</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">overall_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">chain_means</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">chain_means</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">param_data</span><span class="op">$</span><span class="va">chain</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Pooled variance</span></span>
<span>  <span class="va">V</span> <span class="op">&lt;-</span> <span class="va">W</span> <span class="op">+</span> <span class="va">B</span></span>
<span>  </span>
<span>  <span class="co"># Potential scale reduction factor</span></span>
<span>  <span class="va">R_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">V</span> <span class="op">/</span> <span class="va">W</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">R_hat</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Compute R-hat for key parameters - only for existing columns</span></span>
<span><span class="co"># First, get the actual columns that exist in beta_samples</span></span>
<span><span class="va">existing_beta_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta_samples</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^beta_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta_samples</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">existing_cp_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cp_samples</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^cp_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cp_samples</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Extract segment numbers from column names</span></span>
<span><span class="va">beta_segments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"beta_"</span>, <span class="st">""</span>, <span class="va">existing_beta_cols</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cp_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"cp_"</span>, <span class="st">""</span>, <span class="va">existing_cp_cols</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute R-hat only for existing parameters</span></span>
<span><span class="va">rhat_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">beta_segments</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">gelman_rubin</span><span class="op">(</span><span class="va">beta_samples</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"beta_"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rhat_cp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">cp_indices</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">gelman_rubin</span><span class="op">(</span><span class="va">cp_samples</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cp_"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nGelman-Rubin diagnostic (R-hat) - values close to 1 indicate convergence:"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nBeta parameters:"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">beta_segments</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n  beta_"</span>, <span class="va">beta_segments</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">": "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rhat_beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nChange-point parameters:"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">cp_indices</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n  cp_"</span>, <span class="va">cp_indices</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">": "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rhat_cp</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Display convergence plots</span></span>
<span><span class="va">p_beta_conv</span></span></code></pre></div>
<p><img src="Ex2_seir_attack_rate_files/figure-html/convergence_check-1.png" width="960"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_cp_conv</span></span></code></pre></div>
<p><img src="Ex2_seir_attack_rate_files/figure-html/convergence_check-2.png" width="960"></p>
</div>
<div class="section level3">
<h3 id="convergence-assessment">5.4 Convergence Assessment<a class="anchor" aria-label="anchor" href="#convergence-assessment"></a>
</h3>
<p>The convergence diagnostics above help assess whether the RJMCMC
chains have converged:</p>
<ul>
<li>
<strong>R-hat values</strong>: Should be close to 1.0 (typically
&lt; 1.1 is acceptable)</li>
<li>
<strong>Between-chain variation</strong>: Beta values and
change-points should show similar distributions across chains</li>
<li>
<strong>Visual inspection</strong>: Boxplots should show similar
spreads and medians across chains</li>
</ul>
<p>If convergence is poor, consider: - Increasing the number of
iterations - Extending the burn-in period - Adjusting the proposal
distributions - Checking for multimodality in the posterior</p>
</div>
<div class="section level3">
<h3 id="acceptance-ratio-details">5.5 Acceptance Ratio Details<a class="anchor" aria-label="anchor" href="#acceptance-ratio-details"></a>
</h3>
<p>The RJMCMC implementation uses the theoretical framework from
Lyyjynen (2014) §5.2:</p>
<ul>
<li>
<p><strong>Birth acceptance ratio</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mfrac><mrow><mi>π</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>θ</mi><mi>′</mi><mo>,</mo><mi>k</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>π</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>θ</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>×</mo><mfrac><mrow><mi>q</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>θ</mi><mo>,</mo><mi>k</mi><mo stretchy="false" form="prefix">|</mo><mi>θ</mi><mi>′</mi><mo>,</mo><mi>k</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>q</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>θ</mi><mi>′</mi><mo>,</mo><mi>k</mi><mi>′</mi><mo stretchy="false" form="prefix">|</mo><mi>θ</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>×</mo><mrow><mo stretchy="true" form="prefix">|</mo><mi>J</mi><mo stretchy="true" form="postfix">|</mo></mrow></mrow><annotation encoding="application/x-tex">A = \frac{\pi(\theta', k')}{\pi(\theta, k)} \times \frac{q(\theta, k|\theta', k')}{q(\theta', k'|\theta, k)} \times |J|</annotation></semantics></math></p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\pi(\cdot)</annotation></semantics></math>
is the posterior density</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">q(\cdot)</annotation></semantics></math>
is the proposal density<br>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">|</mo><mi>J</mi><mo stretchy="true" form="postfix">|</mo></mrow><annotation encoding="application/x-tex">|J|</annotation></semantics></math>
is the Jacobian determinant for the transformation</li>
</ul>
</li>
<li><p><strong>Death acceptance ratio</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>A</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><annotation encoding="application/x-tex">A^{-1}</annotation></semantics></math>
(reciprocal of birth ratio)</p></li>
<li><p><strong>Proposal probabilities</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mi>k</mi></msub><annotation encoding="application/x-tex">b_k</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>d</mi><mi>k</mi></msub><annotation encoding="application/x-tex">d_k</annotation></semantics></math>
derived from Poisson prior ratios</p></li>
<li><p><strong>Jacobian</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">|</mo><mi>J</mi><mo stretchy="true" form="postfix">|</mo></mrow><mo>≈</mo><msub><mi>h</mi><mtext mathvariant="normal">parent</mtext></msub><mi>/</mi><msubsup><mi>u</mi><mn>2</mn><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">|J| \approx h_{\text{parent}} / u_2^2</annotation></semantics></math>
for the height transformation</p></li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by David Hodgson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
